<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="LiuSw">
    
    <title>
        
            Haproxy 端口转发及负载均衡配置 |
        
        Warren&#39; Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.ico">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.ico","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"心若有所向往，何惧道阻且长。   ▶️"},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Warren&#39; Blog
            </a>
        </div>


        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/navigate"
                            >
                                导航
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/navigate">导航</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Haproxy 端口转发及负载均衡配置</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">LiuSw</span>
                        
                            <span class="author-label">Lv6</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2024-11-21 19:09:48
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Haproxy/">Haproxy</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Haproxy/">Haproxy</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>9.4k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>43 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="Haproxy-端口转发及负载均衡配置"><a href="#Haproxy-端口转发及负载均衡配置" class="headerlink" title="Haproxy 端口转发及负载均衡配置"></a>Haproxy 端口转发及负载均衡配置</h1><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">前面已经详细介绍了Haproxy基础知识 , 今天这里再赘述下Haproxy的重定向跳转的设置.  haproxy利用acl来实现haproxy动静分离，然而在许多运维应用环境中，可能需要将访问的站点请求跳转到指定的站点上，比如客户单端访问kevin.a.com需要将请求转发到bobo.b.com或将http请求重定向到https请求，再比如当客户端访问出错时，需要将错误code代码提示请求到指定的错误页面，诸如此类需求实现，这种情况下就需要利用haproxy的重定向功能来达到此目的。</span><br><span class="line"></span><br><span class="line">Haproxy是一款提供高可用性、负载均衡以及基于TCP（第四层）和HTTP（第七层）应用的代理软件，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。 Haproxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。Haproxy运行在时下的硬件上，完全可以支持数以万计的 并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。</span><br><span class="line"></span><br><span class="line">Haproxy实现了一种事件驱动、单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户端(User-Space) 实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以 使每个CPU时间片(Cycle)做更多的工作。</span><br><span class="line"></span><br><span class="line">Haproxy支持连接拒绝 : 因为维护一个连接的打开的开销是很低的，有时我们很需要限制攻击蠕虫（attack bots），也就是说限制它们的连接打开从而限制它们的危害。 这个已经为一个陷于小型DDoS攻击的网站开发了而且已经拯救了很多站点，这个优点也是其它负载均衡器没有的。</span><br></pre></td></tr></table></figure>

<h2 id="一-Haproxy实现request请求重定向"><a href="#一-Haproxy实现request请求重定向" class="headerlink" title="一. Haproxy实现request请求重定向"></a>一. Haproxy实现request请求重定向</h2><p>关于Hproxy 请求重定向主要会用到: redirect  和 redir 这两类重定向配置语法。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1) redirect重定向用法: (redirect通常配置在haproxy acl部分)</span><br><span class="line">redirect一般有两个指令来执行HTTP重定向：</span><br><span class="line">http-requets redirect       #此种方式支持日志变量格式</span><br><span class="line">redirect                           #此种方式只依赖于静态字符串</span><br><span class="line"></span><br><span class="line">这两个指令的语法是相同的，即redirect现在被认为是传统和配置应该移动到http-request redirect形式。</span><br><span class="line">还有一个主要区别是：http-request redirect使用日志可变格式, 而redirect语句只依赖于静态字符串。</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">2) redirect三种重定向方式</span><br><span class="line">a) 位置重定向</span><br><span class="line">使用语法如下:</span><br><span class="line">redirect location &lt;loc&gt; [code &lt;code&gt;] &lt;option&gt; [&#123;if | unless&#125; &lt;condition&gt;]</span><br><span class="line"></span><br><span class="line">使用位置重定向，例如下面所示指令可以将用户重定向到所提供的精确位置， 该位置可以是第三方URL链接，也可以是本地web服务的另一个访问路径.</span><br><span class="line">1.http-request redirect location &lt;loc&gt; [code &lt;code&gt;] [&lt;option&gt;] [&lt;condition&gt;]</span><br><span class="line">2.redirect location &lt;loc&gt; [code &lt;code&gt;] [&lt;option&gt;] [&lt;condition&gt;]</span><br><span class="line"></span><br><span class="line">相关指令参数如下：</span><br><span class="line">* &lt;loc&gt; ：一个日志格式变量 （或简单的字符串redirect语句）描述了新位置；</span><br><span class="line">* code &lt;code&gt;（可选）：HTTP重定向的状态代码来执行。 此选项下的允许的状态码如下所示：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* &lt;option&gt;（可选):  可以是以下任何或组合的声明：</span><br><span class="line">1. set-cookie NAME[=value] :一个Set-Cookie头部被添加到重定向。该cookie被命名为名称，可以有一个可选的值值。</span><br><span class="line">2. clear-cookie NAME[=]一个特殊的Set-Cookie头被添加到重定向。该Cookie名为名称和最大年龄的cookie参数设置为0，目的是为了指示浏览器删除cookie。 </span><br><span class="line"></span><br><span class="line">注意:  在于浏览器中，这是两个不同的Cookie：NAME和NAME = 以上根据您的流量模式，必须将两个语句适应。</span><br><span class="line"></span><br><span class="line">* if | unless :  用于条件判断</span><br><span class="line">*&lt;condition&gt; （可选）：用于匹配acl，一般为acl的名称</span><br><span class="line"></span><br><span class="line">b) 前缀重定向</span><br><span class="line">使用语法如下:</span><br><span class="line">redirect prefix &lt;loc&gt; [code &lt;code&gt;] &lt;option&gt; [&#123;if | unless&#125; &lt;condition&gt;]</span><br><span class="line"></span><br><span class="line">使用前缀重定向，将用户重定向到由concateneting建立了一个网址&lt;pfx&gt;和完整的原始URI路径：</span><br><span class="line">1. http-request redirect prefix &lt;pfx&gt; [code &lt;code&gt;] [&lt;option&gt;] [&lt;condition&gt;]</span><br><span class="line">2. redirect prefix &lt;pfx&gt; [code &lt;code&gt;] [&lt;option&gt;] [&lt;condition&gt;]</span><br><span class="line"></span><br><span class="line">相关指令参数如下：</span><br><span class="line">* &lt;pfx&gt;: 一个日志格式变量 （或简单的字符串redirect语句）描述了新的位置前缀。</span><br><span class="line">* code &lt;code&gt;（可选）：HTTP重定向的状态代码来执行。 此选项下的允许的状态码如下所示：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* &lt;option&gt;（可选): 可以是以下任何或组合的声明：</span><br><span class="line">drop-query ：在执行串联时从原来的URL删除查询字符串</span><br><span class="line">append-slash ：配合使用drop-query ，在该URL的末尾添加一个“/”字符</span><br><span class="line">set-cookie NAME[=value] ：一个Set-Cookie头部被添加到重定向。该cookie被命名为名称，可以有一个可选的值值。</span><br><span class="line">clear-cookie NAME[=] ：一个特殊的Set-Cookie头被添加到重定向。该Cookie名为名称和最大年龄的cookie参数设置为0，目的是为了指示浏览器删除cookie。</span><br><span class="line"></span><br><span class="line">* if | unless :用于条件判断</span><br><span class="line">* &lt;condition&gt; （可选）：用于匹配acl，一般为acl的名称 </span><br><span class="line"></span><br><span class="line">c) 协议（计划)重定向（比如将http重定向到https）</span><br><span class="line">使用语法如下:</span><br><span class="line">redirect scheme &lt;sch&gt; [code &lt;code&gt;] &lt;option&gt; [&#123;if | unless&#125; &lt;condition&gt;]</span><br><span class="line"></span><br><span class="line">使用位置重定向，例如下面所示指令可以将用户重定向到所提供的新的http协议url链接， 一般用于非安全链接跳转到安全链接，比如http跳转到https上</span><br><span class="line">1. http-request redirect scheme &lt;schloc&gt; [code &lt;code&gt;] [&lt;option&gt;] [&lt;condition&gt;]</span><br><span class="line">2. redirect scheme &lt;sch&gt; [code &lt;code&gt;] [&lt;option&gt;] [&lt;condition&gt;]</span><br><span class="line"></span><br><span class="line">相关指令参数如下：</span><br><span class="line">* &lt;loc&gt; ：一个日志格式变量 （或简单的字符串redirect语句）描述了新位置；</span><br><span class="line">* code &lt;code&gt;（可选）：HTTP重定向的状态代码来执行。 此选项下的允许的状态码如下所示：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* &lt;option&gt;（可选): 可以是以下任何或组合的声明：</span><br><span class="line">1. set-cookie NAME[=value] :一个Set-Cookie头部被添加到重定向。该cookie被命名为名称，可以有一个可选的值值。</span><br><span class="line">2. clear-cookie NAME[=]一个特殊的Set-Cookie头被添加到重定向。该Cookie名为名称和最大年龄的cookie参数设置为0，目的是为了指示浏览器删除cookie。</span><br><span class="line"></span><br><span class="line">注意: 在于浏览器中，这是两个不同的Cookie：NAME和NAME = 以上根据你的流量模式，必须将两个语句适应。</span><br><span class="line"></span><br><span class="line">* if | unless :用于条件判断</span><br><span class="line">* &lt;condition&gt; （可选）：用于匹配acl，一般为acl的名称</span><br><span class="line"></span><br><span class="line">一个简单的实例:</span><br><span class="line"></span><br><span class="line">acl http      ssl_fc,not</span><br><span class="line">http-request redirect scheme https if http</span><br><span class="line">下面是redirect 综合应用的一个小示例:</span><br><span class="line"></span><br><span class="line">acl clear      dst_port  80</span><br><span class="line">acl secure     dst_port  8080</span><br><span class="line">acl login_page url_beg   /login</span><br><span class="line">acl logout     url_beg   /logout</span><br><span class="line">acl uid_given  url_reg   /login?userid=[^&amp;]+</span><br><span class="line">acl cookie_set hdr_sub(cookie) SEEN=1</span><br><span class="line"> </span><br><span class="line">redirect prefix   https://kevin.com set-cookie SEEN=1 if !cookie_set</span><br><span class="line">redirect prefix   https://kevin.com           if login_page !secure</span><br><span class="line">redirect prefix   http://kevin.com drop-query if login_page !uid_given</span><br><span class="line">redirect location http://kevin.com/           if !login_page secure</span><br><span class="line">redirect location / clear-cookie USERID=      if logout</span><br><span class="line">总结: redirect三种重定向可以混合使用，比较常用的有redirect prefix 和 redirect location这两种方式，从某种理解上可以交差使用；</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">3) redir重定向用法:(redir通常配置在haproxy backend部分)</span><br><span class="line">使用redir 会将发往backend的站点服务请求均以302状态响应发给需要重定向的server服务或站点，此时haproxy不需要向后端web server提交请求；需要注意的是，在prefix后面不能使用/，且不能使用相对地址，以避免造成循环，例如:</span><br><span class="line"></span><br><span class="line">frontend  main *:80</span><br><span class="line">    default_backend app</span><br><span class="line">backend app</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server node1 127.0.0.1:81 check weight 3 redir http://www.kevin.com</span><br><span class="line">上面配置含义:所有发往localhost:81的请求做重定向，重定向到www.kevin.com因此可以实现单台服务器的重定向</span><br><span class="line"></span><br><span class="line">又例如，如果我们要讲访问的站点重定向到grace.com</span><br><span class="line"></span><br><span class="line">frontend  main *:80</span><br><span class="line">    default_backend  app</span><br><span class="line">backend app</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server node1 127.0.0.1:81 check weight 3 redir http://www.grace.com</span><br><span class="line">注意:redir只做跳转，如客户端输入:http://ip ,将会跳转到指定的页面上，此时客户端的页面的页面也会跳转到指定的页面上，之后所有的请求都会递交到该站点（前提该站点可以与客户端通讯），而不再发往haproxy代理站点，haproxy也不需要往后端web server提交客户端发过来的请求。</span><br></pre></td></tr></table></figure>

<h2 id="二-haproxy实现error重定向"><a href="#二-haproxy实现error重定向" class="headerlink" title="二. haproxy实现error重定向"></a>二. haproxy实现error重定向</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">格式为: errorfile 错误代码code 错误代码响应提示页路径</span><br><span class="line">* errorfile 即根据客户端页面错误code状态将指定的错误状态页面提示给客户端，比如友情提示页面，一般如下:</span><br><span class="line"></span><br><span class="line">errorfile 403 /etc/haproxy/errorfiles/403.http</span><br><span class="line">errorfile 500 /etc/haproxy/errorfiles/500.http</span><br><span class="line">errorfile 502 /etc/haproxy/errorfiles/502.http</span><br><span class="line">errorfile 503 /etc/haproxy/errorfiles/503.http</span><br><span class="line">errorfile 504 /etc/haproxy/errorfiles/504.http</span><br><span class="line">例如:如果想访问403页面重定向到其他页面的话 (errorloc)，则参考以下配置:</span><br><span class="line"></span><br><span class="line">frontend web_server</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend webserver</span><br><span class="line">    acl badguy src 172.16.50.10</span><br><span class="line">    block if badguy</span><br><span class="line">    errorloc 403 http://grace.com/         #定义错误页面重定向</span><br><span class="line">errorfile  表示在用户请求不存在的页面时，返回一个页面给客户端而非有haproxy生成的错误代码，可用于所有段中;</span><br><span class="line">格式: errorfile &lt;code&gt; &lt;file&gt;</span><br><span class="line"></span><br><span class="line">errorloc  表示请求错误时，返回一个HTTP重定向至某URL的信息，可以用于所有端中;</span><br><span class="line">格式: errorloc &lt;code&gt; &lt;url&gt;</span><br><span class="line"></span><br><span class="line">总结: 错误重定向可以更加友好地提示客户端错误状态，比如做定制页面化跳转，以及网站维护升级等等，当出现错误时，可以及时跳转到预定好错误提示页面上。 </span><br></pre></td></tr></table></figure>

<h2 id="三-haproxy定义规则"><a href="#三-haproxy定义规则" class="headerlink" title="三. haproxy定义规则"></a>三. haproxy定义规则</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1) haproxy常用的acl匹配条件</span><br><span class="line"></span><br><span class="line">-i：不区分&lt;value&gt;中模式字符的大小写；</span><br><span class="line"> -f：从指定的文件中加载模式；   </span><br><span class="line"> </span><br><span class="line">path_beg：用于测试请求的URL是否以&lt;string&gt;指定的模式开头</span><br><span class="line">    例：匹配url以/static、/images、/javascript /stylesheets开头</span><br><span class="line">    acl url_static  path_beg  -i  /static /images /javascript /stylesheets</span><br><span class="line"> </span><br><span class="line">path_end：用于测试请求的URL是否以&lt;string&gt;指定的模式结尾</span><br><span class="line">    例：匹配url以jpg、gif、png、css、js结尾</span><br><span class="line">    acl url_static  path_end -i .jpg .gif .png .css .js</span><br><span class="line"> </span><br><span class="line">hdr_beg：用于测试请求报文的指定首部的开头部分是否符合&lt;string&gt;指定的模式</span><br><span class="line">    例：匹配请求的主机以img、video、download或ftp开头</span><br><span class="line">    acl host_static hdr_beg(host) -i img. video. download. ftp.</span><br><span class="line">    即匹配访问的域名是img.bobo.com,video.bobo.com,download.bobo.com,ftp.bobo.com</span><br><span class="line"> </span><br><span class="line">url_beg：匹配的是整个url</span><br><span class="line">    例：匹配url为http://www.bobo.com.com</span><br><span class="line">    acl is_bobo.com url_beg http://www.bobo.com.com</span><br><span class="line">    use_backend bobo.com if is_bobo.com</span><br><span class="line"> </span><br><span class="line">dst_port：判断请求的端口</span><br><span class="line"> </span><br><span class="line">hdr_sub：判断客户的user-agent</span><br><span class="line">    例：判断客户端的user-agent是否为手机</span><br><span class="line">    acl shouji hdr_sub(user-agent) -i android iphone</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">2) haproxy定义分发规则</span><br><span class="line"></span><br><span class="line">根据请求的主机头，实现不同项目的请求，分发到不同的backend</span><br><span class="line"> </span><br><span class="line">hdr_beg(host):判断主机头</span><br><span class="line"> </span><br><span class="line">例如:</span><br><span class="line">acl is_www hdr_beg(host) -i www.bobo.com.com</span><br><span class="line">acl is_wap hdr_beg(host) -i wap.bobo.com.com</span><br><span class="line">acl is_erp hdr_beg(host) -i erp.bobo.com.com</span><br><span class="line">acl is_interface hdr_beg(host) -i interface.bobo.com.com</span><br><span class="line">use_backend tomcat_erp_v2 if is_erp</span><br><span class="line">use_backend tomcat_interface_v2 if is_interface</span><br><span class="line">use_backend tomcat_web_v2 if is_www</span><br><span class="line">use_backend tomcat_mobile_v2 if is_wap</span><br><span class="line"> </span><br><span class="line">通过定义以上规则即可实现访问不同的域名分发到不同的backend</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">3) haproxy定义重定向规则</span><br><span class="line"></span><br><span class="line">prefix:表示重定向url</span><br><span class="line">location:表示重定向访问路径，即url不变，url后边跟的路径发生改变</span><br><span class="line"> </span><br><span class="line">例如:</span><br><span class="line">redirect prefix http://weihu.bobo.com.com/PC if is_www</span><br><span class="line">redirect prefix http://weihu.bobo.com.com/H5 if is_wap</span><br><span class="line"> </span><br><span class="line">说明：</span><br><span class="line">当访问is_www时，重定向到weihu.bobo.com.com/PC</span><br><span class="line">当访问is_wap时，重定向到weihu.bobo.com.com/H5</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">4) haproxy定义放行规则</span><br><span class="line"></span><br><span class="line">仅放行通过验证的IP地址或者IP范围段；</span><br><span class="line"> </span><br><span class="line">例如:</span><br><span class="line">如果访问的是is_www，但来源IP不是指定的IP时，用http-request deny进行拒绝；</span><br><span class="line"> </span><br><span class="line">acl is_www hdr_beg(host) -i www.bobo.com.com</span><br><span class="line">acl is_dns src 172.16.60.0/24 218.65.212.0/24</span><br><span class="line">http-request deny if is_www  !is_dns（满足条件的直接进行拒绝）  </span><br><span class="line"> </span><br><span class="line">也可以写为：</span><br><span class="line">acl is_www hdr_beg(host) -i www.bobo.com.com</span><br><span class="line">acl is_dns src 172.16.60.0/24 218.65.212.0/24</span><br><span class="line">user_backend www if is_www  is_dns（两个条件同时满足才使用后端的www）</span><br><span class="line"> </span><br><span class="line">说明：</span><br><span class="line">源地址有多个时，用空格进行隔开</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">5) haproxy定义手机只能访问手机端，电脑端只能访问电脑端规则</span><br><span class="line"></span><br><span class="line">例如:</span><br><span class="line">当手机访问www.bobo.com时转发到wap.bobo.com</span><br><span class="line">当电脑访问wap.bobo.com时转发到www.bobo.com</span><br><span class="line"> </span><br><span class="line">配置如下:</span><br><span class="line">acl is_shouji hdr_sub(user-agent) -i android iphone</span><br><span class="line">acl is_diannao hdr_beg(host) www</span><br><span class="line">redirect prefix http://wap.bobo.com if shouji</span><br><span class="line">redirect prefix http://www.bobo.com if is_diannao !is_shouji</span><br><span class="line">Haproxy 重定向跳转 - 示例 1</span><br><span class="line"></span><br><span class="line">(1) 首先每个域名解析到自己的ip</span><br><span class="line">www.kevin.com   172.16.51.100</span><br><span class="line">www.grace.com   172.16.51.200</span><br><span class="line">www.bobo.com    172.16.51.210</span><br><span class="line"> </span><br><span class="line">(2) 域名重定向</span><br><span class="line">acl name_redirectA hdr_beg(host) -i www.kevin.com</span><br><span class="line">redirect prefix http://www.bobo.com/A if name_redirectA</span><br><span class="line"> </span><br><span class="line">acl name_redirectB hdr_beg(host) -i  www.grace.com</span><br><span class="line">redirect prefix http://www.bobo.com/B if name_redirectB</span><br><span class="line"> </span><br><span class="line">(3) 跳转规则</span><br><span class="line">acl name_A hdr_beg(host) -i www.kevin.com</span><br><span class="line">acl name_B hdr_beg(host) -i www.grace.com</span><br><span class="line">acl name_C hdr_beg(host) -i www.bobo.com</span><br><span class="line">acl api_reqA path_beg -i /A/api</span><br><span class="line">acl api_reqB path_beg -i /B/api</span><br><span class="line">use_backend appserver_8081 if name_A or name_B      #匹配&quot;或&quot;的规则</span><br><span class="line">use_backend appserver_8082_A if name_C api_reqA     #匹配&quot;和&quot;的规则</span><br><span class="line">use_backend appserver_8082_B if name_C api_reqB      </span><br><span class="line"> </span><br><span class="line">backend appserver_8081</span><br><span class="line">   balance source</span><br><span class="line">   server web1 172.16.51.171:8081 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line">   server web2 172.16.51.174:8081 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"> </span><br><span class="line">backend appserver_8082_A</span><br><span class="line">   server web1 172.16.51.180:80 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line">  </span><br><span class="line">backend appserver_8082_B</span><br><span class="line">   server web1 172.16.51.180:80 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line">Haproxy 重定向跳转 - 示例 2</span><br><span class="line"></span><br><span class="line">redirect location &lt;to&gt; [code &lt;code&gt;] &lt;option&gt; [&#123;if | unless&#125; &lt;condition&gt;]</span><br><span class="line">redirect prefix &lt;to&gt; [code &lt;code&gt;] &lt;option&gt; [&#123;if | unless&#125; &lt;condition&gt;] 重定向，相当于rewrite</span><br><span class="line">  </span><br><span class="line">示例配置如下:</span><br><span class="line">acl shibo hdr_reg(host) -i ^(shibo.kevin.com|forum.kevin.com)       #使用正则匹配</span><br><span class="line">acl shibo_path path_beg -i /shibo                #url 目录</span><br><span class="line">acl youxi path_beg -i /youxi              </span><br><span class="line">acl static path_end -i .html .css .js      #url 结尾文件</span><br><span class="line">acl php path_end -i .php </span><br><span class="line">acl jsp path_end -i .jsp .do </span><br><span class="line">  </span><br><span class="line">use_backend shibo_pool if shibo or shibo_path       #注意&quot;或&quot;的匹配用&quot;or&quot;</span><br><span class="line">use_backend youxi_pool if youxi</span><br><span class="line">use_backend static_pool if static </span><br><span class="line">use_backend php_pool if php</span><br><span class="line">use_backend jsp_pool if jsp</span><br><span class="line">default_backend www.kevin.com                </span><br><span class="line"> </span><br><span class="line">#当满足host_bb.cn的策略,跳转(重定向)到http://www.bb.cn</span><br><span class="line">acl host_bb.cn hdr_beg(host) -i (bb.cn|beijing.com)</span><br><span class="line">redirect prefix http://www.bb.cn if host_bb.cn</span><br><span class="line">  </span><br><span class="line">#有个问题: haproxy能否在接到一个请求时选择一个后端服务器，然后301重定向url 。</span><br><span class="line">#主要原因是他有5个1G的出口，这样就能充分利用其带宽。</span><br><span class="line">#测试了一下是可以的</span><br><span class="line">frontend free</span><br><span class="line">   bind *:80</span><br><span class="line">   default_backend lvs2</span><br><span class="line">backend lvs2</span><br><span class="line">   mode http</span><br><span class="line">   option forwardfor header ORIG_CLIENT_IP</span><br><span class="line">   server free174 172.16.51.16:8081 redir http://free71-174-grace.com:8081 weight 10 rise 3 fall 5 check inter 2000</span><br><span class="line">   server free173 172.16.51.15:8081 redir http://free71-173-grace.com:8081 weight 10 rise 3 fall 5 check inter 2000</span><br><span class="line">       </span><br><span class="line">#当输入负载均衡机器的域名后，url会直接变成http://free71-17(3|4)-grace.com:8081.</span><br><span class="line">  </span><br><span class="line">acl monitor hdr_beg(host) -i monitor.kevin.com        #定义ACL名称(monitor),对应的请求的主机头是monitor.kevin.com </span><br><span class="line">acl shibo hdr_reg(host) -i ^(shibo.kevin.com|forum.kevin.com)  #使用正则匹配</span><br><span class="line">acl host_bb.cn hdr_beg(host) -i bb.cn</span><br><span class="line">acl host_hui.cn hdr_beg(host) -i beijing.com</span><br><span class="line">redirect prefix http://www.bb.cn if host_bb.cn</span><br><span class="line">redirect prefix http://www.bb.cn if host_hui.cn</span><br><span class="line">  </span><br><span class="line">frontend localhost</span><br><span class="line">    bind *:80</span><br><span class="line">    bind *:443 ssl crt /etc/ssl/bb.web/bb.web.pem</span><br><span class="line">    redirect scheme https if !&#123; ssl_fc &#125;</span><br><span class="line">    mode http</span><br><span class="line">    default_backend nodes</span><br><span class="line"> </span><br><span class="line"># 上面配置中, 添加了redirect导向，如果连接不是通过SSL连接的，它将http重定向到https</span><br><span class="line">  </span><br><span class="line">acl host_bb.cn hdr_beg(host) -i bb.cn</span><br><span class="line">acl host_jiu.cn hdr_beg(host) -i beijing.com</span><br><span class="line">acl www_jiu.cn hdr_beg(host) -i www.beijing.com</span><br><span class="line">acl host_hui.cn hdr_beg(host) -i pp.com</span><br><span class="line">acl www_hui.cn hdr_beg(host) -i www.pp.com</span><br><span class="line">redirect prefix http://www.bb.cn if host_bb.cn</span><br><span class="line">redirect prefix http://www.bb.cn if host_jiu.cn</span><br><span class="line">redirect prefix http://www.bb.cn if www_jiu.cn</span><br><span class="line">redirect prefix http://www.bb.cn if host_hui.cn</span><br><span class="line">redirect prefix http://www.bb.cn if www_hui.cn</span><br><span class="line">  </span><br><span class="line">访问bb.cn,beijing.com,www.beijing.com,pp.com,www.pp.cpm 都跳转到http://www.bb.cn</span><br><span class="line">Haproxy 重定向跳转 - 示例 3 (手机规则匹配)</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">一.  线上业务的实际需求</span><br><span class="line">现在根据业务的实际需要，有以下几种不同的需求。如下：</span><br><span class="line"> </span><br><span class="line">a) 转发所有手机请求</span><br><span class="line">所有通过手机端访问http.shibo.com域名的话，全部转发到http://www.shibo.com这个地址，而PC端不受此限制。</span><br><span class="line"> </span><br><span class="line">b) 根据url进行转发</span><br><span class="line">如果手机端请求http.shibo.com这个域名的url中，以docs或者manager这两个关键词开头的话，把该请求转发到后端的服务器，而PC端不受此限制。</span><br><span class="line"> </span><br><span class="line">也就是说手机端访问具体的url地址的话，可以正常访问。如果是直接访问http.shibo.com域名的话，直接把该请求转发到http://www.shibo.com这个地址。</span><br><span class="line"> </span><br><span class="line">============================================================</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">二.  haproxy配置</span><br><span class="line">下面根据不同的业务需求进行配置haproxy，如下。</span><br><span class="line">a) 转发所有手机请求配置</span><br><span class="line">要把所有的手机端请求转到www.shibo.com这个地址，需要我们首先把访问的终端匹配出来，haproxy可以通过hdr_sub(user-agent)这个参数把手机端匹配出来。</span><br><span class="line"> </span><br><span class="line">手机端匹配出来后，我们就可以定义相应的规则，把手机端的请求转发到www.shibo.com这个地址了。haproxy.cf配置文件如下：</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">   log 127.0.0.1 local0</span><br><span class="line">   log 127.0.0.1 local1 notice</span><br><span class="line">   maxconn 4096</span><br><span class="line">   uid 188</span><br><span class="line">   gid 188</span><br><span class="line">   daemon</span><br><span class="line">   tune.ssl.default-dh-param 2048</span><br><span class="line"> </span><br><span class="line">defaults</span><br><span class="line">   log global</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   option dontlognull</span><br><span class="line">   option http-server-close</span><br><span class="line">   option forwardfor except 127.0.0.1</span><br><span class="line">   option redispatch</span><br><span class="line">   retries 3</span><br><span class="line">   option redispatch</span><br><span class="line">   maxconn 2000</span><br><span class="line">   timeout http-request 10s</span><br><span class="line">   timeout queue 1m</span><br><span class="line">   timeout connect 10s</span><br><span class="line">   timeout client 1m</span><br><span class="line">   timeout server 1m</span><br><span class="line">   timeout http-keep-alive 10s</span><br><span class="line">   timeout check 10s</span><br><span class="line">   maxconn 3000</span><br><span class="line"> </span><br><span class="line">listen admin_stats</span><br><span class="line">   bind 0.0.0.0:1080</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   maxconn 10</span><br><span class="line">   stats refresh 30s</span><br><span class="line">   stats uri /stats</span><br><span class="line">   stats auth admin:admin</span><br><span class="line">   stats hide-version</span><br><span class="line"> </span><br><span class="line">frontend weblb</span><br><span class="line">   bind *:80</span><br><span class="line">   acl is_http hdr_beg(host) http.shibo.com</span><br><span class="line">   acl ua hdr_sub(user-agent) -i android iphone</span><br><span class="line">   redirect prefix http://www.shibo.com if ua</span><br><span class="line">   use_backend httpserver if is_http</span><br><span class="line"> </span><br><span class="line">backend httpserver</span><br><span class="line">    balance source</span><br><span class="line">    server web1 127.0.0.1:8080 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"></span><br><span class="line">温馨提示:</span><br><span class="line">在以上配置文件中，有以下两行需要注意：</span><br><span class="line">acl ua hdr_sub(user-agent) -i android iphone</span><br><span class="line">redirect prefix http://www.shibo.com if ua</span><br><span class="line"> </span><br><span class="line">这两行:</span><br><span class="line">第一行是第一个ua规则，该规则是判断是否是手机端。</span><br><span class="line">注意：在此手机端，我们只匹配了安卓手机和iphone。</span><br><span class="line">第二行是跳转规则，如果匹配是手机端的话，那么直接跳转到http://www.shibo.com这个地址。</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">如果是PC端的话，默认跳转到httpserver这个后端服务器组。</span><br><span class="line">以上配置是一台服务器对外只提供一个域名访问的请求，如果有两个域名的话，就要进行如下配置：</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">   log 127.0.0.1 local0</span><br><span class="line">   log 127.0.0.1 local1 notice</span><br><span class="line">   maxconn 4096</span><br><span class="line">   uid 188</span><br><span class="line">   gid 188</span><br><span class="line">   daemon</span><br><span class="line">   tune.ssl.default-dh-param 2048</span><br><span class="line"> </span><br><span class="line">defaults</span><br><span class="line">   log global</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   option dontlognull</span><br><span class="line">   option http-server-close</span><br><span class="line">   option forwardfor except 127.0.0.1</span><br><span class="line">   option redispatch</span><br><span class="line">   retries 3</span><br><span class="line">   option redispatch</span><br><span class="line">   maxconn 2000</span><br><span class="line">   timeout http-request 10s</span><br><span class="line">   timeout queue 1m</span><br><span class="line">   timeout connect 10s</span><br><span class="line">   timeout client 1m</span><br><span class="line">   timeout server 1m</span><br><span class="line">   timeout http-keep-alive 10s</span><br><span class="line">   timeout check 10s</span><br><span class="line">   maxconn 3000</span><br><span class="line"> </span><br><span class="line">listen admin_stats</span><br><span class="line">   bind 0.0.0.0:1080</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   maxconn 10</span><br><span class="line">   stats refresh 30s</span><br><span class="line">   stats uri /stats</span><br><span class="line">   stats auth admin:admin</span><br><span class="line">   stats hide-version</span><br><span class="line"> </span><br><span class="line">frontend weblb</span><br><span class="line">   bind *:80</span><br><span class="line">   acl is_http hdr_beg(host) http.shibo.com</span><br><span class="line">   acl is_haproxy hdr_beg(host) haproxy.shibo.com</span><br><span class="line">   acl ua hdr_sub(user-agent) -i android iphone</span><br><span class="line">   redirect prefix http://www.shibo.com if ua !is_haproxy</span><br><span class="line">   use_backend haproxyserver if ua is_haproxy</span><br><span class="line">   use_backend haproxyserver if is_haproxy</span><br><span class="line">   use_backend httpserver if is_http</span><br><span class="line"> </span><br><span class="line">backend httpserver</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:8080 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"> </span><br><span class="line">backend haproxyserver</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:7070 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">b) 测试转发所有手机请求</span><br><span class="line">在手机浏览器中输入http.shibo.com会自动跳转到http://www.shibo.com这个地址。</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">c) 根据url进行转发配置</span><br><span class="line">根据手机端请求的url进行转发的话，首先也是需要匹配出手机端，然后定义url路径规则。最后结合手机端和url路径规则，进行跳转。</span><br><span class="line">haproxy具体配置文件，如下：</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">   log 127.0.0.1 local0</span><br><span class="line">   log 127.0.0.1 local1 notice</span><br><span class="line">   maxconn 4096</span><br><span class="line">   uid 188</span><br><span class="line">   gid 188</span><br><span class="line">   daemon</span><br><span class="line">   tune.ssl.default-dh-param 2048</span><br><span class="line"> </span><br><span class="line">defaults</span><br><span class="line">   log global</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   option dontlognull</span><br><span class="line">   option http-server-close</span><br><span class="line">   option forwardfor except 127.0.0.1</span><br><span class="line">   option redispatch</span><br><span class="line">   retries 3</span><br><span class="line">   option redispatch</span><br><span class="line">   maxconn 2000</span><br><span class="line">   timeout http-request 10s</span><br><span class="line">   timeout queue 1m</span><br><span class="line">   timeout connect 10s</span><br><span class="line">   timeout client 1m</span><br><span class="line">   timeout server 1m</span><br><span class="line">   timeout http-keep-alive 10s</span><br><span class="line">   timeout check 10s</span><br><span class="line">   maxconn 3000</span><br><span class="line"> </span><br><span class="line">listen admin_stats</span><br><span class="line">   bind 0.0.0.0:1080</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   maxconn 10</span><br><span class="line">   stats refresh 30s</span><br><span class="line">   stats uri /stats</span><br><span class="line">   stats auth admin:admin</span><br><span class="line">   stats hide-version</span><br><span class="line"> </span><br><span class="line">frontend weblb</span><br><span class="line">   bind *:80</span><br><span class="line">   acl is_http hdr_beg(host) http.shibo.com</span><br><span class="line">   acl is_docs url_beg /docs /manager</span><br><span class="line">   acl ua hdr_sub(user-agent) -i android iphone</span><br><span class="line">   redirect prefix http://www.shibo.com if ua !is_docs</span><br><span class="line">   use_backend httpserver if ua is_docs</span><br><span class="line">   use_backend httpserver if is_http</span><br><span class="line"> </span><br><span class="line">backend httpserver</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:8080 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"> </span><br><span class="line">温馨提示:</span><br><span class="line">在上述配置文件中，需要以下几行解释下:</span><br><span class="line"> </span><br><span class="line">acl is_docs url_beg /docs /manager</span><br><span class="line">定义一个is_docs规则。如果url以/docs或者/manager开头的，则全部属于该规则。</span><br><span class="line"> </span><br><span class="line">acl ua hdr_sub(user-agent) -i android iphone</span><br><span class="line">redirect prefix http://www.shibo.com if ua !is_docs</span><br><span class="line">这两行首先是匹配出手机端，然后如果是手机端访问，并且访问的不是is_docs规则的话，则直接跳转到http://www.shibo.com这个地址。</span><br><span class="line"> </span><br><span class="line">use_backend httpserver if ua is_docs</span><br><span class="line">这条命令是，如果是手机端访问，并且访问的是is_docs规则的话，则直接跳转到httpserver这个后端服务器组。</span><br><span class="line"> </span><br><span class="line">如果是PC端的话，默认跳转到httpserver这个后端服务器组。</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d) 测试根据url进行转发</span><br><span class="line">手机端访问http://http.shibo.com/docs/这个连接的话，是可以直接访问的。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">三.  其他haproxy相关配置</span><br><span class="line">上面说明了有关手机的相关配置，在实际的生产环境中，有时候还会碰到一些奇奇怪怪的要求。</span><br><span class="line">比如要求所有手机端访问的http.shibo.com，转到指定的页面。haproxy主要配置文件如下：</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line"> </span><br><span class="line">frontend weblb</span><br><span class="line">   bind *:80</span><br><span class="line">   acl is_http hdr_beg(host) http.shibo.com</span><br><span class="line">   acl ua hdr_sub(user-agent) -i android iphone</span><br><span class="line">   redirect prefix http://www.shibo.com/?p=10624 if ua</span><br><span class="line">   use_backend httpserver if is_http</span><br><span class="line"> </span><br><span class="line">backend httpserver</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:8080 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"> </span><br><span class="line">以上配置是所有手机端访问的，都跳转到http://www.shibo.com/?p=10624这个页面。</span><br><span class="line">haproxy重定向跳转 - 示例4 (修改路径, 即重写URL)</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1) 访问https://www.shibo.com/guo-hui 重定向跳转到 https://www.xiaobo.com/an-hui</span><br><span class="line">frontend https</span><br><span class="line">    option http-server-close</span><br><span class="line">    reqadd X-Forwarded-Proto:\ https</span><br><span class="line"> </span><br><span class="line">    acl shi_bo hdr(host) -i www.shibo.com</span><br><span class="line">    acl guo_hui path_beg /guo-hui</span><br><span class="line">    acl an_hui path_beg /an-hui</span><br><span class="line"> </span><br><span class="line">    reqirep ^([^\ ]*\ /)guo-hui(.*) \1an-hui\2 if shi_bo guo_hui              #注意中间的空格, 以及\1 和 \2;</span><br><span class="line">    redirect prefix https://www.xiaobo.com code 301 if shi_bo an_hui</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2) 访问http://front-end/app-2/do-that 重定向跳转到 http://back-end/app-2-another-path/do-that</span><br><span class="line">frontend http  </span><br><span class="line">   acl do-that path_end -i /app-2/do-that</span><br><span class="line">   use_backend server1 if do-that</span><br><span class="line"> </span><br><span class="line">backend server1</span><br><span class="line">   reqirep ^([^\ :]*)\ /app-2/(.*)  \1\ /app-2-another-path/\2</span><br><span class="line">   server server 172.16.60.51</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">3) 访问原请求为 http://www.kevin.com/OLD/ab...</span><br><span class="line">    重定向到 http://www.kevin.com/NEW/ab...</span><br><span class="line"> </span><br><span class="line">在nginx里可以通过rewrite来实现跳转配置, 配置内容如下:</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.kevin.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        rewrite ^/OLD(.*) /NEW$1 permanent;</span><br><span class="line">        proxy_pass http://backend_www_kevin_com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">在haproxy里重定向跳转的配置如下:</span><br><span class="line">frontend web80</span><br><span class="line">    bind *:80</span><br><span class="line">     </span><br><span class="line">    acl domain_www_kevin_com hdr_beg(host) -i www.kevin.com kevin.com</span><br><span class="line">    acl url_old  url_beg   -i /old</span><br><span class="line"> </span><br><span class="line">    reqirep ^([^\ ]*)\ /old(.*) \1\ /new\2  if domain_www_kevin_com url_old</span><br><span class="line">    use_backend kevin_com   if domain_www_kevin_com</span><br><span class="line">    </span><br><span class="line">最后总结:</span><br><span class="line">通过以上haproxy和nginx的重写配置, 可以看出二者配置的不同在于:</span><br><span class="line">-  http://www.kevin.com/old，后端真实服务器收到的请求被重写为 /new/ ，并且浏览器收到 HTTP/1.1 302 Location: /new/ ,</span><br><span class="line">   地址栏改为 http://www.kevin.com/new/</span><br><span class="line">-  http://www.kevin.com/old/，或者 http://www.kevin.com/old/ab... 后端真实服务器收到的请求被重写为 /new/ ，</span><br><span class="line">   浏览器并没有收到 302 , 地址栏依旧为 http://www.kevin.com/old/</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">4) haproxy URL 重新 , 如下两个规范配置</span><br><span class="line">reqirep ^([^\ ]*)\ /books/(.*) \1\ /books.php?title=\2</span><br><span class="line">reqirep ^([^\ ]*)\ /(.*)  \1\ /wdn/\2</span><br><span class="line"> </span><br><span class="line"># 注意中间的空格, 以及\1 和 \2</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">5) reqirep可以修改http的头; 如果haproxy 配置里要替换主机头, 则:</span><br><span class="line">   在backend 选项下面加入：</span><br><span class="line">   reqirep ^Host:\ (.*) Host:\ 标识</span><br><span class="line">haproxy重定向跳转 - 示例5 (错误/黑白名单/动静分离/读写(上传和下载)分离的重定向 )</span><br><span class="line"></span><br><span class="line">(1) haproxy 错误重定向(403), 即黑名单设置</span><br><span class="line">    </span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">   </span><br><span class="line">acl blacklist src 172.16.51.250</span><br><span class="line">http-request deny if blacklist</span><br><span class="line">   </span><br><span class="line">如上配置后, 当来源ip是172.16.51.250时, 就直接返回一个403错误页面!!</span><br><span class="line">   </span><br><span class="line">=============================================================</span><br><span class="line">当haproxy配置里限制一个来源ip访问时, 直接给用户返回403错误页面, 会显得不太友好, 所以haproxy重定向应运而生.</span><br><span class="line">如下配置, 当来源ip是172.16.51.250时, 直接重定向跳转到172.16.51.10的8000端口的错误页面</span><br><span class="line">    </span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">    </span><br><span class="line">acl badhost src 172.16.51.250</span><br><span class="line">block if badhost</span><br><span class="line">errorloc 403 http://172.16.51.10:8000</span><br><span class="line">    </span><br><span class="line">在172.16.51.10机器上部署nginx, 端口为8000, 然后在nginx根目录的index.html里设置错误页面信息,</span><br><span class="line">错误页面信息可以自己随便定义, 比如&quot;抱歉, 页面临时出错, 运维工程师正在抢修中, 请耐心等待~&quot;</span><br><span class="line">    </span><br><span class="line">(2) haproxy 黑名单重定向</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">    </span><br><span class="line">acl  badhost src 172.16.51.250</span><br><span class="line">redirect location http://172.16.51.10:8000 if  badhost</span><br><span class="line">    </span><br><span class="line">在172.16.51.10机器上部署nginx, 端口为8000, 然后在nginx根目录的index.html里设置错误页面信息,</span><br><span class="line">错误页面信息可以自己随便定义, 比如&quot;抱歉, 这是一个禁止访问的来源ip地址!请尝试从其他机器访问.&quot;</span><br><span class="line">    </span><br><span class="line">(3) haproxy 网页重定向</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">    </span><br><span class="line">acl shibo.com hdr_beg(host) -i shibo.com</span><br><span class="line">redirect code 301 location http://www.shibo.com if shibo.com</span><br><span class="line">    </span><br><span class="line">温馨提示:</span><br><span class="line">如果不写301,只写code默认是302,临时重定向 (不推荐), 加上301则表示永久重定向</span><br><span class="line">    </span><br><span class="line">(4) haproxy 访问IP自动跳转到域名</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">    </span><br><span class="line">acl 172.16.51.10 hdr(host) -i 172.16.51.10</span><br><span class="line">redirect code 301 location http://www.shibo.com if 172.16.51.10</span><br><span class="line">    </span><br><span class="line">(5) haproxy 读写分离 配置 (即上传和下载分离)</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">    </span><br><span class="line">acl read method GET</span><br><span class="line">acl read method HEAD</span><br><span class="line">acl write method PUT</span><br><span class="line">acl write method POST</span><br><span class="line">use_backend dynamic if write</span><br><span class="line">default_backend static</span><br><span class="line">    </span><br><span class="line">backend static                               #&quot;上传&quot;读取操作的负载代理.</span><br><span class="line">    balance   roundrobin</span><br><span class="line">    server    web1 172.16.51.30:80 check          </span><br><span class="line">    </span><br><span class="line">backend  dynamic                         #&quot;下载&quot;写入操作的负载代理</span><br><span class="line">    balance   roundrobin</span><br><span class="line">    server    web2 172.16.51.40:80 check          </span><br><span class="line">   </span><br><span class="line">(6) haproxy 动静分离 配置</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">   </span><br><span class="line">frontend public</span><br><span class="line">      bind            *:80 name clear</span><br><span class="line">      #bind         172.16.51.10:443 ssl crt /etc/haproxy/haproxy.pem</span><br><span class="line">      #use_backend    static if &#123; hdr_beg(host) -i img &#125;</span><br><span class="line">      #use_backend    static if &#123; path_beg /img /css   &#125;</span><br><span class="line">      use_backend    static2 if &#123; path_end -i .php   &#125;</span><br><span class="line">      default_backend static1</span><br><span class="line">   </span><br><span class="line"># The static backend backend for &#x27;Host: img&#x27;, /img and /css.</span><br><span class="line">backend static1</span><br><span class="line">      balance     roundrobin</span><br><span class="line">      server        statsrv1 172.16.51.20:80 check inter 1000</span><br><span class="line">   </span><br><span class="line">backend static2</span><br><span class="line">      balance     roundrobin</span><br><span class="line">      server       statsrv2 172.16.51.30:80 check inter 1000</span><br><span class="line"> </span><br><span class="line">(7) haproxy的白名单设置</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">frontend tcp-8080-front</span><br><span class="line">     bind *:8080</span><br><span class="line">     mode tcp</span><br><span class="line">     default_backend     tcp-8080-back</span><br><span class="line">  </span><br><span class="line">tcp-8080-back</span><br><span class="line">     mode tcp</span><br><span class="line">     balance leastconn</span><br><span class="line">     tcp-request content accept if &#123; src -f /usr/local/haproxy/white_ip_list &#125;</span><br><span class="line">     tcp-request content reject</span><br><span class="line">     server tcp-8080 10.1.27.20:8080</span><br><span class="line"> </span><br><span class="line">配置中/usr/local/haproxy/white_ip_list文件即为白名单文件, 在文件里配置允许的白名单地址: 一行一个IP或者IP段。</span><br><span class="line">haproxy 重定向跳转 - 示例6</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">acl  admin_req  path_beg  -i  /admin</span><br><span class="line">use_backend  admin_80  if  admin_req</span><br><span class="line"> </span><br><span class="line">backend admin_80</span><br><span class="line">      mode   http</span><br><span class="line">      balance   roundrobin</span><br><span class="line">      server   apphost01_8083  172.16.50.133:80  check inter 2000 fall 3</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">接着去172.16.50.133服务器上看下tomcat配置</span><br><span class="line">[root@tomcat-133 ~]# vim /usr/local/tomcat/conf/server.xml</span><br><span class="line">.............</span><br><span class="line">     &lt;Context docBase=&quot;/data02/kevin-web&quot; path=&quot;/&quot; reloadable=&quot;false&quot;/&gt;</span><br><span class="line"> </span><br><span class="line">[root@tomcat-133 ~]# cd /data02/kevin-web</span><br><span class="line">[root@tomcat-133 kevin-web]# ls</span><br><span class="line">admin  adminwechat  index.html  jquery.2.1.4.min.js  META-INF  WEB-INF  kevin-web-0.0.1-SNAPSHOT.war</span><br><span class="line">[root@tomcat-133 kevin-web]# ls</span><br><span class="line">bobo.html</span><br><span class="line"> </span><br><span class="line">最后, 可验证:</span><br><span class="line">访问http://www.kevin.com/admin/bobo.html  实际上返回的是172.16.50.133服务器的/data02/kevin-web/admin/bobo.html页面内容</span><br><span class="line">haproxy 重定向跳转 - 示例7 (haproxy 代理 https)</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">haproxy代理https有两种方式：</span><br><span class="line">1）haproxy服务器本身提供ssl证书，后面的web服务器走正常的http</span><br><span class="line">2）haproxy服务器本身只提供代理，后面的web服务器走https(配置ssl证书)</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">第一种方式：haproxy服务器本身提供ssl证书</span><br><span class="line">  </span><br><span class="line">注意： 需要编译haproxy的时候支持ssl</span><br><span class="line">编译参数：</span><br><span class="line">[root@localhost ~]# make TARGET=linux26 USE_OPENSSL=1 ADDLIB=-lz</span><br><span class="line">[root@localhost ~]# ldd haproxy | grep ssl</span><br><span class="line">libssl.so.10 =&gt; /usr/lib64/libssl.so.10 (0x00007fb0485e5000)</span><br><span class="line">  </span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">frontend https_frontend</span><br><span class="line">    bind *:443 ssl crt /etc/ssl/certs/servername.pem</span><br><span class="line">    mode http</span><br><span class="line">    option httpclose</span><br><span class="line">    option forwardfor</span><br><span class="line">    reqadd X-Forwarded-Proto:\ https</span><br><span class="line">    default_backend web_server</span><br><span class="line">  </span><br><span class="line">backend web_server</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    cookie SERVERID insert indirect nocache</span><br><span class="line">    server s1 172.16.50.150:80 check cookie s1</span><br><span class="line">    server s2 172.16.50.151:80 check cookie s2</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">温馨提示:  这里的pem 文件是下面两个文件合并而成</span><br><span class="line">[root@localhost ~]# cat servername.crt servername.key |tee servername.pem</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">=====================================================</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">第二种方式：haproxy服务器本身只提供代理，没有ssl证书 （一般我们常用的就是这种方式）</span><br><span class="line">  </span><br><span class="line">这种方式，haproxy不需要重新编译支持ssl，简单方便，只需要后面的web服务器配置好ssl即可。</span><br><span class="line">  </span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">.............</span><br><span class="line">.............</span><br><span class="line">frontend https_frontend</span><br><span class="line">    bind *:443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend web_server</span><br><span class="line">  </span><br><span class="line">backend web_server</span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin</span><br><span class="line">    stick-table type ip size 200k expire 30m</span><br><span class="line">    stick on src</span><br><span class="line">    server s1 172.16.50.150:443</span><br><span class="line">    server s2 172.16.50.151:443</span><br><span class="line">  </span><br><span class="line">温馨提示:  这种模式下mode 必须是tcp模式!!!!!!!!</span><br><span class="line">haproxy重定向跳转 - 示例8 (http, https的有关重定向, 案例分析)</span><br><span class="line"></span><br><span class="line">需要提前说明下:</span><br><span class="line">下面配置操作全部是在haproxy1.5.4版本下进行配置和通过测试的!</span><br><span class="line">haproxy1.3版本以下haproxy配置参数可能不能使用，所以需要注意haproxy的版本号</span><br><span class="line">以下的haproxy配置可以在线上生产环境直接使用的!</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">一、业务要求</span><br><span class="line">根据系统业务的实际需要，有以下几种不同的需求：</span><br><span class="line"> </span><br><span class="line">1.1) http跳转https</span><br><span class="line">把所有请求http://http.kevin.com的地址全部跳转为https://http.kevin.com这个地址。</span><br><span class="line"> </span><br><span class="line">1.2) http与https并存</span><br><span class="line">服务器同时开放http://http.kevin.com和https://http.kevin.com的访问形式。</span><br><span class="line"> </span><br><span class="line">1.3) 同台服务器不同域名之间的https与http</span><br><span class="line">同一台服务器对http.kevin.com域名访问的全部跳转为https://http.kevin.com，而对haproxy.kevin.com访问走http协议，</span><br><span class="line">也就是跳转到http://haproxy.kevin.com这个地址。</span><br><span class="line"> </span><br><span class="line">1.4) 同台服务器多域名均使用https</span><br><span class="line">同一台服务器对http.kevin.com和haproxy.kevin.com访问走http是协议。</span><br></pre></td></tr></table></figure>

 <figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">二、配置haproxy, 实现以上业务需求</span><br><span class="line"> </span><br><span class="line">2.1) http跳转https的haproxy配置文件内容</span><br><span class="line">说实话haproxy的https配置要比nginx配置简单的多了，只需要加入几行代码即可实现https的功能。</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">   log 127.0.0.1 local0</span><br><span class="line">   log 127.0.0.1 local1 notice</span><br><span class="line">   maxconn 4096</span><br><span class="line">   uid 188</span><br><span class="line">   gid 188</span><br><span class="line">   daemon</span><br><span class="line">   tune.ssl.default-dh-param 2048</span><br><span class="line"> </span><br><span class="line">defaults</span><br><span class="line">   log global</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   option dontlognull</span><br><span class="line">   option http-server-close</span><br><span class="line">   option forwardfor except 127.0.0.1</span><br><span class="line">   option redispatch</span><br><span class="line">   retries 3</span><br><span class="line">   option redispatch</span><br><span class="line">   maxconn 2000</span><br><span class="line">   timeout http-request 10s</span><br><span class="line">   timeout queue 1m</span><br><span class="line">   timeout connect 10s</span><br><span class="line">   timeout client 1m</span><br><span class="line">   timeout server 1m</span><br><span class="line">   timeout http-keep-alive 10s</span><br><span class="line">   timeout check 10s</span><br><span class="line">   maxconn 3000</span><br><span class="line"> </span><br><span class="line">listen admin_stats</span><br><span class="line">   bind 0.0.0.0:1080</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   maxconn 10</span><br><span class="line">   stats refresh 30s</span><br><span class="line">   stats uri /stats</span><br><span class="line">   stats auth admin:admin</span><br><span class="line">   stats hide-version</span><br><span class="line"> </span><br><span class="line">frontend weblb</span><br><span class="line">   bind *:80</span><br><span class="line">   acl is_http hdr_beg(host) http.kevin.com</span><br><span class="line">   redirect scheme https if !&#123; ssl_fc &#125;</span><br><span class="line">   bind *:443 ssl crt /etc/haproxy/kevin.com.pem</span><br><span class="line">   use_backend httpserver if is_http</span><br><span class="line"> </span><br><span class="line">backend httpserver</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:7070 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"></span><br><span class="line">温馨提示:</span><br><span class="line">在以上配置文件中，只要需要注意下面四个选项的配置：</span><br><span class="line">tune.ssl.default-dh-param 2048                #因为我们的SSL密钥使用的是2048bit加密，所以在此进行声明。</span><br><span class="line"> </span><br><span class="line">acl is_http hdr_beg(host) http.kevin.com</span><br><span class="line">redirect scheme https if !&#123; ssl_fc &#125;</span><br><span class="line">bind *:443 ssl crt /etc/haproxy/kevin.com.pem</span><br><span class="line"># 这三行表示把所有访问http.kevin.com这个域名的请求，全部转发到https://http.kevin.com这个连接。</span><br><span class="line"> </span><br><span class="line">测试:</span><br><span class="line">发现在浏览器中，无论输入的是http.kevin.com, 还是http://http.kevin.com, 亦或是https://http.kevin.com，都会自动跳转到https://http.kevin.com。</span><br><span class="line">这样就达到了，把所有的http请求跳转到https的目的。</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">2.2) http与https并存配置</span><br><span class="line">haproxy要实现http和https并存的话，配置也很简单，只需要把haproxy分别监控不同的端口就行，配置文件如下：</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">   log 127.0.0.1 local0</span><br><span class="line">   log 127.0.0.1 local1 notice</span><br><span class="line">   maxconn 4096</span><br><span class="line">   user haproxy</span><br><span class="line">   group haproxy</span><br><span class="line">   daemon</span><br><span class="line">   tune.ssl.default-dh-param 2048</span><br><span class="line"> </span><br><span class="line">defaults</span><br><span class="line">   log global</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   option dontlognull</span><br><span class="line">   retries 3</span><br><span class="line">   option redispatch</span><br><span class="line">   maxconn 2000</span><br><span class="line">   timeout connect 5000ms</span><br><span class="line">   timeout client 50000ms</span><br><span class="line">   timeout server 50000ms</span><br><span class="line"> </span><br><span class="line">listen admin_stats</span><br><span class="line">   bind 0.0.0.0:1080</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   maxconn 10</span><br><span class="line">   stats refresh 30s</span><br><span class="line">   stats uri /stats</span><br><span class="line">   stats auth admin:admin</span><br><span class="line">   stats hide-version</span><br><span class="line"> </span><br><span class="line">frontend weblb</span><br><span class="line">   bind *:80</span><br><span class="line">   acl is_http hdr_beg(host) http.kevin.com</span><br><span class="line">   use_backend httpserver if is_http</span><br><span class="line"> </span><br><span class="line">backend httpserver</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:7070 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"> </span><br><span class="line">frontend weblb443</span><br><span class="line">   bind *:443 ssl crt /etc/haproxy/kevin.com.pem</span><br><span class="line">   acl is_443 hdr_beg(host) http.kevin.com</span><br><span class="line">   use_backend httpserver443 if is_443</span><br><span class="line"> </span><br><span class="line">backend httpserver443</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:7070 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"></span><br><span class="line">温馨提示:</span><br><span class="line">在以上配置文件中，定义了两个前端，一个前端用于监听80端口，也就是http协议。另外一个前端监听443端口，也就是https协议。</span><br><span class="line">此时haproxy会根据客户端请求的协议进行分发，如果发现客户端请求的是http协议，则把该请求分发到监听80端口的前端。</span><br><span class="line">如果发现客户端请求的是https协议，则把该请求分发到监听443端口的前端。如此就达到了haproxy让http和https并存的要求。</span><br><span class="line"> </span><br><span class="line">测试:</span><br><span class="line">通过测试会发现，在浏览器中如果输入的是http://http.kevin.com或者是http.kevin.com都会直接跳转到http://http.kevin.com，</span><br><span class="line">而输入的是https://http.kevin.com，则只会跳转到https://http.kevin.com。</span><br><span class="line">如此就到达了，我们业务的要求实现http和https并存。</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">2.3) 同台服务器不同域名之间的https与http配置</span><br><span class="line">同台服务器不同域名之间的http和https配置比较复杂，第一需要监听两个端口，第二还要根据不同的域名进行分发。</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">   log 127.0.0.1 local0</span><br><span class="line">   log 127.0.0.1 local1 notice</span><br><span class="line">   maxconn 4096</span><br><span class="line">   uid 188</span><br><span class="line">   gid 188</span><br><span class="line">   daemon</span><br><span class="line">   tune.ssl.default-dh-param 2048</span><br><span class="line"> </span><br><span class="line">defaults</span><br><span class="line">   log global</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   option dontlognull</span><br><span class="line">   option http-server-close</span><br><span class="line">   option forwardfor except 127.0.0.1</span><br><span class="line">   option redispatch</span><br><span class="line">   retries 3</span><br><span class="line">   option redispatch</span><br><span class="line">   maxconn 2000</span><br><span class="line">   timeout http-request 10s</span><br><span class="line">   timeout queue 1m</span><br><span class="line">   timeout connect 10s</span><br><span class="line">   timeout client 1m</span><br><span class="line">   timeout server 1m</span><br><span class="line">   timeout http-keep-alive 10s</span><br><span class="line">   timeout check 10s</span><br><span class="line">   maxconn 3000</span><br><span class="line"> </span><br><span class="line">listen admin_stats</span><br><span class="line">   bind 0.0.0.0:1080</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   maxconn 10</span><br><span class="line">   stats refresh 30s</span><br><span class="line">   stats uri /stats</span><br><span class="line">   stats auth admin:admin</span><br><span class="line">   stats hide-version</span><br><span class="line"> </span><br><span class="line">frontend weblb</span><br><span class="line">   bind *:80</span><br><span class="line">   acl is_haproxy hdr_beg(host) haproxy.kevin.com</span><br><span class="line">   acl is_http hdr_beg(host) http.kevin.com</span><br><span class="line">   redirect prefix https://http.kevin.com if is_http</span><br><span class="line">   use_backend haproxyserver if is_haproxy</span><br><span class="line"> </span><br><span class="line">backend haproxyserver</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:9090 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"> </span><br><span class="line">frontend weblb443</span><br><span class="line">   bind *:443 ssl crt /etc/haproxy/kevin.com.pem</span><br><span class="line">   acl is_443 hdr_beg(host) http.kevin.com</span><br><span class="line">   use_backend httpserver443 if is_443</span><br><span class="line"> </span><br><span class="line">backend httpserver443</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:7070 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"></span><br><span class="line">温馨提示:</span><br><span class="line">同台服务器不同域名之间的https与http配置，上面配置了两个前端一个用于监听80端口，并且根据不同的域名进行跳转。</span><br><span class="line">在80端口的规则中，如果客户端请求的是http.kevin.com，这个域名的话，则haproxy会把该请求直接跳转到https://http.kevin.com。</span><br><span class="line">如果是haproxy.kevin.com，这个域名的话，则分发到后端的服务器。</span><br><span class="line">另外一个前端用于监听443端口，用于分发客户端https://http.kevin.com的请求。</span><br><span class="line"> </span><br><span class="line">测试:</span><br><span class="line">可以发现在浏览器中输入haproxy.kevin.com会跳转到http://haproxy.kevin.com这个地址，</span><br><span class="line">而如果输入的是http.kevin.com或者是http://http.kevin.com，亦或是https://http.kevin.com的话，都会跳转到https://http.kevin.com。</span><br><span class="line">如此就达到了上面的业务要求，同台服务器上访问haproxy.kevin.com直接跳转到80端口，如果访问的是http.kevin.com域名的话则跳转</span><br><span class="line">到https://http.kevin.com这个地址。</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">2.4) 同台服务器多域名均使用https配置</span><br><span class="line">要使同台服务器的两个设置多个域名都使用https协议的话，配置很简单。只需要在haproxy中启用各自的https配置即可。</span><br><span class="line">[root@localhost ~]# vim /usr/local/haproxy/conf/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">   log 127.0.0.1 local0</span><br><span class="line">   log 127.0.0.1 local1 notice</span><br><span class="line">   maxconn 4096</span><br><span class="line">   uid 108</span><br><span class="line">   gid 116</span><br><span class="line">   daemon</span><br><span class="line">   tune.ssl.default-dh-param 2048</span><br><span class="line"> </span><br><span class="line">defaults</span><br><span class="line">   log global</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   option dontlognull</span><br><span class="line">   option http-server-close</span><br><span class="line">   option forwardfor except 127.0.0.1</span><br><span class="line">   option redispatch</span><br><span class="line">   retries 3</span><br><span class="line">   option redispatch</span><br><span class="line">   timeout http-request 10s</span><br><span class="line">   timeout queue 1m</span><br><span class="line">   timeout connect 10s</span><br><span class="line">   timeout client 1m</span><br><span class="line">   timeout server 1m</span><br><span class="line">   timeout http-keep-alive 10s</span><br><span class="line">   timeout check 10s</span><br><span class="line">   maxconn 3000</span><br><span class="line"> </span><br><span class="line">listen admin_stats</span><br><span class="line">   bind 0.0.0.0:1080</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   maxconn 10</span><br><span class="line">   stats refresh 30s</span><br><span class="line">   stats uri /stats</span><br><span class="line">   stats auth admin:admin</span><br><span class="line">   stats hide-version</span><br><span class="line"> </span><br><span class="line">frontend web80</span><br><span class="line">   bind *:80</span><br><span class="line">   acl is_http hdr_beg(host) http.kevin.com</span><br><span class="line">   redirect scheme https if !&#123; ssl_fc &#125;</span><br><span class="line"> </span><br><span class="line">   bind *:443 ssl crt /etc/haproxy/kevin.com.pem</span><br><span class="line">   acl is_haproxy hdr_beg(host) haproxy.kevin.com</span><br><span class="line">   redirect scheme https if !&#123; ssl_fc &#125;</span><br><span class="line"> </span><br><span class="line">   bind *:443 ssl crt /etc/haproxy/kevin.com.pem</span><br><span class="line">   use_backend httpserver if is_http</span><br><span class="line">   use_backend haproxyserver if is_haproxy</span><br><span class="line"> </span><br><span class="line">backend httpserver</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:6060 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line"> </span><br><span class="line">backend haproxyserver</span><br><span class="line">   balance source</span><br><span class="line">   server web1 127.0.0.1:9090 maxconn 1024 weight 3 check inter 2000 rise 2 fall 3</span><br></pre></td></tr></table></figure>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">测试:</span><br><span class="line">在浏览中无论是输入http.kevin.com、http://http.kevin.com，还是haproxy.kevin.com、http://haproxy.kevin.com，都会跳转到相应的https地址。</span><br><span class="line">这也达到了业务的要求</span><br></pre></td></tr></table></figure>


<p><code>来源博客园 https://www.cnblogs.com/kevingrace/p/10182538.html</code></p>

        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/20241121/Kubernetes/df70045b3de2/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">kubelet修改PLEG的检查时间为30s</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/20241121/Kubernetes/3b6599c83b50/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Kubernetes之安装 Kuboard v2</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'BEMpJudeFXa6gjjzQJLS7NdH-gzGzoHsz',
                    appKey: 'AQI7N2UG34MNLRmctkce1siE',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '客官,留下点什么吧!',
                    lang: 'zh-CN'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'LiuSw';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2025&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">LiuSw</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
 
                   <!-- 特殊符号显示ღゝ◡╹)ノ♡  -->
                   <span id="binft" class="my-face" style="color:#FF00FF">ღゝ◡╹)ノ♡</span>
                    <script>
                      var binft = function (r) {
                        function t() {
                        return b[Math.floor(Math.random() * b.length)]
                      }  
                      function e() {
                        return String.fromCharCode(94 * Math.random() + 1)
                      }
                      function n(r) {
                        for (var n = document.createDocumentFragment(), i = 0; r > i; i++) {
                          var l = document.createElement("span");
                          l.textContent = e(), l.style.color = t(), n.appendChild(l)
                        }
                        return n
                      }
                      function i() {
                        var t = o[c.skillI];
                        c.step ? c.step-- : (c.step = g, c.prefixP < l.length ? (c.prefixP >= 0 && (c.text += l[c.prefixP]), c.prefixP++) : "forward" === c.direction ? c.skillP < t.length ? (c.text += t[c.skillP], c.skillP++) : c.delay ? c.delay-- : (c.direction = "backward", c.delay = a) : c.skillP > 0 ? (c.text = c.text.slice(0, -1), c.skillP--) : (c.skillI = (c.skillI + 1) % o.length, c.direction = "forward")), r.textContent = c.text, r.appendChild(n(c.prefixP < l.length ? Math.min(s, s + c.prefixP) : Math.min(s, t.length - c.skillP))), setTimeout(i, d)
                      }
                      var l = "",
                      o = ["ღ","ღゝ◡","ღゝ◡╹)","ღゝ◡╹)ノ♡"].map(function (r) {
                      return r + ""
                      }),
                      a = 2,
                      g = 1,
                      s = 5,
                      d = 75,
                      b = ["rgb(110,64,170)", "rgb(150,61,179)", "rgb(191,60,175)", "rgb(228,65,157)", "rgb(254,75,131)", "rgb(255,94,99)", "rgb(255,120,71)", "rgb(251,150,51)", "rgb(226,183,47)", "rgb(198,214,60)", "rgb(175,240,91)", "rgb(127,246,88)", "rgb(82,246,103)", "rgb(48,239,130)", "rgb(29,223,163)", "rgb(26,199,194)", "rgb(35,171,216)", "rgb(54,140,225)", "rgb(76,110,219)", "rgb(96,84,200)"],
                      c = {
                        text: "",
                        prefixP: -s,
                        skillI: 0,
                        skillP: 0,
                        direction: "forward",
                        delay: a,
                        step: g
                      };
                      i()
                      };
                      binft(document.getElementById('binft'));
                    </script>
                   <!--特殊符号代码结束 -->


                   <!--新增天数代码 -->
                    <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
                      <script>
                        var now = new Date(); 
                        function createtime() { 
                          var grt= new Date("01/01/2019 00:00:00");//在此处修改你的建站时间
                          now.setTime(now.getTime()+250); 
                          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
                          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
                          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
                          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
                          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
                          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
                          document.getElementById("timeDate").innerHTML = "<br> 本站已安全运行 " + '<font style=color:#0aa858>' + dnum + '</font>' + " 天 "; 
                          document.getElementById("times").innerHTML = ' <font style=color:#2d85f0>' + hnum + '</font>' + " 小时 " + '<font style=color:#f4433c>' + mnum + '</font>' + " 分 " + '<font style=color:#ffbc32>' + snum + '</font>' + " 秒"; 
                        } 
                        setInterval("createtime()",250);
                      </script>
                     <!--新增天数结束 -->

                    </span>
                
            </div>
        
        <div class="theme-info info-item">
          <!--  由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a> -->
        </div>
        
            <div class="icp-info info-item"><a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn"> <img style="margin:0 0 -4px 0" src="/images/备案图标.png" />  吉ICP备 2020008057号-1</a></div>
        
        
    </div>


</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Haproxy-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E5%8F%8A%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE"><span class="nav-text">Haproxy 端口转发及负载均衡配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-Haproxy%E5%AE%9E%E7%8E%B0request%E8%AF%B7%E6%B1%82%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-text">一. Haproxy实现request请求重定向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-haproxy%E5%AE%9E%E7%8E%B0error%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-text">二. haproxy实现error重定向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-haproxy%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99"><span class="nav-text">三. haproxy定义规则</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>





<script type="text/javascript" src="https://libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>
<!-- 页面点击小红心 -->
<!-- <script type="text/javascript" src="/js/love.js"></script> -->
<!-- 浏览器搞笑标题 -->
<script type="text/javascript" src="/js/FunnyTitle.js"></script>
<!-- 雪花特效 -->
<!-- < script type="text/javascript" src="/js/snow.js"></script> -->
<!-- 左下小人 -->
<script type="text/javascript" src="/js/wali-svg.js"></script>
<!-- 点击烟花 -->
<script type="text/javascript" src="/js/yanhua.js"></script>
<!-- 背景添加动态线条效果 -->
<script type="text/javascript" color="102,204,255" opacity='4' zIndex="1" count="60" src="/js/canvas-nest.min.js" ></script> 
<!-- 样式二（飘动的彩带） -->
<script type="text/javascript" src="/js/ribbon.js"></script>


</body>
</html>
